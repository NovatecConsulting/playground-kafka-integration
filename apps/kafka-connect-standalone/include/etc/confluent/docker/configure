#!/usr/bin/env bash
#
# adopted from original confluent docker build [1] with
# additional connector properties for standalone mode.
#
# [1] https://raw.githubusercontent.com/confluentinc/kafka-images/6.1.x/kafka-connect-base/include/etc/confluent/docker/configure
#

. /etc/confluent/docker/bash-config

# ensure connect worker properties

dub ensure CONNECT_BOOTSTRAP_SERVERS
dub ensure CONNECT_KEY_CONVERTER
dub ensure CONNECT_VALUE_CONVERTER

. /etc/confluent/docker/defaults

if [[ $CONNECT_KEY_CONVERTER == "io.confluent.connect.avro.AvroConverter" ]]
then
  dub ensure CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL
fi

if [[ $CONNECT_VALUE_CONVERTER == "io.confluent.connect.avro.AvroConverter" ]]
then
  dub ensure CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL
fi

# ensure connect connector properties

dub ensure CONNECTOR_NAME
dub ensure CONNECTOR_CONNECTOR_CLASS

# templating

dub path /etc/"${COMPONENT}"/ writable

dub template "/etc/confluent/docker/${COMPONENT}-worker.properties.template" "/etc/${COMPONENT}/${COMPONENT}-worker.properties"
dub template "/etc/confluent/docker/${COMPONENT}-connector.properties.template" "/etc/${COMPONENT}/${COMPONENT}-connector.properties"

# The connect-distributed script expects the log4j config at /etc/kafka/connect-log4j.properties.
dub template "/etc/confluent/docker/log4j.properties.template" "/etc/kafka/connect-log4j.properties"